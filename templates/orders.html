{% extends "base.html" %}

{% block title %}Orders - {{ restaurant_name }}{% endblock %}

{% block styles %}
<style>
    .order-card {
        margin-bottom: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        max-width: 100%;
    }
    
    .order-card.new-order {
        animation: highlight 2s ease-in-out;
    }
    
    @keyframes highlight {
        0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.8); background-color: #fff9e6; }
        70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); background-color: #fffdf5; }
        100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); background-color: #ffffff; }
    }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 3px 8px;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .status-pending {
        background-color: #ffc107;
        color: #212529;
    }
    
    .status-preparing {
        background-color: #17a2b8;
        color: white;
    }
    
    .status-ready {
        background-color: #28a745;
        color: white;
    }
    
    .status-completed {
        background-color: #6c757d;
        color: white;
    }
    
    .status-cancelled {
        background-color: #dc3545;
        color: white;
    }
    
    .no-orders-message {
        text-align: center;
        padding: 30px;
        border-radius: 8px;
        background-color: #f8f9fa;
        color: #6c757d;
    }
    
    .order-item-card {
        border-radius: 6px;
        background-color: #f8f9fa;
        padding: 8px;
        margin-bottom: 8px;
        transition: all 0.2s;
        font-size: 0.9rem;
    }
    
    .order-item-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .order-total {
        font-weight: bold;
        margin-top: 10px;
        text-align: right;
        font-size: 0.95rem;
        border-top: 1px solid #eee;
        padding-top: 8px;
    }
    
    .status-action-btn {
        margin-right: 5px;
        border-radius: 20px;
        font-size: 0.8rem;
        transition: all 0.2s;
        padding: 4px 12px;
    }
    
    .status-action-btn:hover {
        transform: translateY(-2px);
    }
    
    .order-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        padding: 0.75rem 1rem;
    }
    
    .order-header h5 {
        font-size: 1rem;
        margin-bottom: 0;
    }
    
    .order-header .text-muted {
        font-size: 0.8rem;
    }
    
    .refresh-icon {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .auto-refresh-indicator {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .time-indicator {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .item-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 8px;
    }
    
    .item-quantity {
        font-size: 1rem;
        font-weight: bold;
        color: #007bff;
    }
    
    .item-name {
        margin-bottom: 3px;
        font-weight: 500;
        font-size: 0.85rem;
    }
    
    .item-price {
        color: #6c757d;
        font-size: 0.8rem;
    }
    
    .card-body {
        padding: 0.75rem;
    }
    
    /* Add print styles */
    .print-receipt-btn {
        font-size: 0.8rem;
        padding: 3px 8px;
        border-radius: 4px;
    }
    
    /* Compact view for the grid layout */
    @media (min-width: 992px) {
        .orders-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
    }
    
    @media (min-width: 1200px) {
        .orders-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-utensils me-2"></i> {{ restaurant_name }} Orders</h1>
        <div>
            <span id="socket-status" class="me-3 badge bg-secondary">Socket: Connecting...</span>
            <span id="refresh-status" class="auto-refresh-indicator me-3">Auto-refreshing with Socket.IO</span>
            <button id="refresh-btn" class="btn btn-primary">
                <i id="refresh-icon" class="fas fa-sync-alt me-1"></i> Refresh Now
        </button>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-12">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h3 class="mb-0 fs-4">Active Orders</h3>
                    <span id="last-updated" class="time-indicator">Last updated: just now</span>
                </div>
                <div class="card-body p-0">
                    <div id="active-orders" class="p-3">
                        {% if active_orders %}
                            <div class="orders-grid">
                                {% for order in active_orders %}
                                    <div class="order-card" data-order-id="{{ order.id }}">
                                        <div class="card-header order-header">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">Order #{{ order.id }}</h5>
                                                <span class="status-badge status-{{ order.status }}">{{ order.status|capitalize }}</span>
                                            </div>
                                            <div class="text-muted mt-1">
                                                <i class="fas fa-chair me-1"></i> Table {{ order.table.number }} 
                                                <i class="fas fa-clock ms-2 me-1"></i> {{ order.created_at.strftime('%H:%M') }}
                                                {% if order.customer_phone %}
                                                <i class="fas fa-phone ms-2 me-1"></i> {{ order.customer_phone }}
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <!-- Grid layout for items -->
                                            <div class="item-grid mb-2">
                                                {% for item in order.items %}
                                                    <div class="order-item-card">
                                                        <div class="item-quantity">{{ item.quantity }}x</div>
                                                        <div class="item-name">{{ item.menu_item.name }}</div>
                                                        <div class="item-price">${{ "%.2f"|format(item.quantity * item.unit_price) }}</div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                            
                                            {% if order.special_instructions %}
                                            <div class="alert alert-info mb-2 p-2">
                                                <strong><i class="fas fa-info-circle me-1"></i>Special:</strong>
                                                <small>{{ order.special_instructions }}</small>
                                            </div>
                                            {% endif %}
                                            
                                            <div class="order-total">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <small>Subtotal:</small>
                                                    <small>${{ "%.2f"|format(order.total_amount) }}</small>
                                                </div>
                                                <div class="d-flex justify-content-between mb-1">
                                                    <small>Tax (8%):</small>
                                                    <small>${{ "%.2f"|format(order.tax_amount) }}</small>
                                                </div>
                                                <div class="d-flex justify-content-between fw-bold">
                                                    <span>Total:</span>
                                                    <span>${{ "%.2f"|format(order.final_amount) }}</span>
                                                </div>
                                                {% if order.payment_method %}
                                                <div class="text-end mt-2">
                                                    <span class="badge bg-{{ 'success' if order.payment_status == 'paid' else 'warning' }}">
                                                        <i class="fas fa-{{ 'credit-card' if order.payment_method == 'now' else 'money-bill-wave' }} me-1"></i>
                                                        {{ 'Paid (Card)' if order.payment_method == 'now' and order.payment_status == 'paid' else 'Pay at Table' }}
                                                    </span>
                        </div>
                                                {% endif %}
                    </div>
                    
                                            <div class="d-flex justify-content-between align-items-center mt-2">
                                                <div>
                                                    <button class="btn btn-sm btn-outline-secondary print-receipt-btn" 
                                                            onclick="printReceipt({{ order.id }})">
                                                        <i class="fas fa-print me-1"></i> Print
                                                    </button>
                                                </div>
                                                <div>
                                                    {% if order.status == 'pending' %}
                                                        <div class="d-flex gap-2 mt-3">
                                                            <button class="btn btn-sm btn-primary" onclick="updateOrderStatus({{ order.id }}, 'preparing')">
                                                                <i class="fas fa-utensils me-1"></i>Start Preparing
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-danger" onclick="cancelOrder({{ order.id }})">
                                                                <i class="fas fa-times me-1"></i>Cancel
                                                            </button>
                                                        </div>
                                                    {% elif order.status == 'preparing' %}
                                                        <div class="d-flex gap-2 mt-3">
                                                            <button class="btn btn-sm btn-success" onclick="updateOrderStatus({{ order.id }}, 'ready')">
                                                                <i class="fas fa-check me-1"></i>Mark Ready
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-danger" onclick="cancelOrder({{ order.id }})">
                                                                <i class="fas fa-times me-1"></i>Cancel
                                                            </button>
                                                        </div>
                                                    {% elif order.status == 'ready' %}
                                                        <div class="d-flex gap-2 mt-3">
                                                            <button class="btn btn-sm btn-secondary" onclick="updateOrderStatus({{ order.id }}, 'completed')">
                                                                <i class="fas fa-check-double me-1"></i>Mark Completed
                                                            </button>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="no-orders-message">
                                <i class="fas fa-coffee fa-2x mb-3"></i>
                                <h5>No active orders at the moment</h5>
                                <p class="mb-0">New orders will appear here automatically</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white py-3">
                    <h3 class="mb-0 fs-4">Recent Completed Orders</h3>
                </div>
                <div class="card-body p-0">
                    <div id="completed-orders" class="p-3">
                        {% if completed_orders %}
                {% for order in completed_orders %}
                                <div class="card mb-3 order-card">
                                    <div class="card-header order-header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">Order #{{ order.id }}</h5>
                                            <span class="status-badge status-completed">Completed</span>
                                        </div>
                                        <div class="text-muted mt-1">
                                            <i class="fas fa-chair me-1"></i> Table {{ order.table.number }} 
                                            <i class="fas fa-clock ms-3 me-1"></i> {{ order.updated_at.strftime('%H:%M:%S') }}
                                        </div>
                    </div>
                                    <div class="card-body p-3">
                                        <div class="item-grid">
                            {% for item in order.items %}
                                                <div class="order-item-card">
                                                    <div class="item-quantity">{{ item.quantity }}x</div>
                                                    <div class="item-name">{{ item.menu_item.name }}</div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-orders-message">
                                <i class="fas fa-check-circle fa-2x mb-3"></i>
                                <h5>No completed orders yet</h5>
                                <p class="mb-0">Completed orders will appear here</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Order Status Modal -->
<div class="modal fade" id="status-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Order Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Update status for <strong>Order #<span id="order-id-display"></span></strong> from Table <span id="table-number-display"></span>?</p>
                <div class="mb-3">
                    <label for="status-select" class="form-label">New Status</label>
                    <select id="status-select" class="form-select">
                        <option value="pending">Pending</option>
                        <option value="preparing">Preparing</option>
                        <option value="ready">Ready</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="update-status-btn">Update Status</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
        // Socket.IO connection
        const socket = io();
        const socketStatus = document.getElementById('socket-status');
        const restaurantId = {{ current_user.id }};
        let isConnected = false;
        
        // Initialize audio for notifications
        const newOrderSound = new Audio('/static/sounds/new-order.mp3');
        
        // DOM Elements
        const refreshBtn = document.getElementById('refresh-btn');
        const refreshIcon = document.getElementById('refresh-icon');
        const refreshStatus = document.getElementById('refresh-status');
        const lastUpdated = document.getElementById('last-updated');
    const activeOrdersContainer = document.getElementById('active-orders');
        
        // Socket connection events
        socket.on('connect', function() {
            console.log('Socket connected');
            socketStatus.textContent = 'Socket: Connected';
            socketStatus.classList.remove('bg-secondary', 'bg-danger');
            socketStatus.classList.add('bg-success');
            isConnected = true;
            
            // Join restaurant room for notifications
            socket.emit('join_restaurant', {
                restaurant_id: restaurantId
            });
        });
        
        socket.on('disconnect', function() {
            console.log('Socket disconnected');
            socketStatus.textContent = 'Socket: Disconnected';
            socketStatus.classList.remove('bg-success', 'bg-secondary');
            socketStatus.classList.add('bg-danger');
            isConnected = false;
        });
        
        socket.on('connecting', function() {
            socketStatus.textContent = 'Socket: Connecting...';
            socketStatus.classList.remove('bg-success', 'bg-danger');
            socketStatus.classList.add('bg-secondary');
        });
        
        socket.on('connect_error', function(error) {
            console.error('Connection error:', error);
            socketStatus.textContent = 'Socket: Error';
            socketStatus.classList.remove('bg-success', 'bg-secondary');
            socketStatus.classList.add('bg-danger');
        });
        
        // Listen for room join confirmation
        socket.on('room_joined', function(data) {
            console.log('Joined room:', data.room);
        });
        
        // Listen for order updates
        socket.on('order_update', function(data) {
            console.log('Order update received:', data);
            updateOrderInUI(data);
            updateLastUpdatedTime();
            
            // Play sound for new orders
            if (data.type === 'new') {
                try {
                    newOrderSound.play();
                } catch (e) {
                    console.error('Error playing new order sound:', e);
                }
            }
        });
        
        // Listen for notifications
        socket.on('notification', function(notification) {
            console.log('Notification received:', notification);
        });
        
        // Listen for play sound events
        socket.on('play_sound', function(data) {
            console.log('Play sound:', data.sound);
            if (data.sound === 'new_order') {
                try {
                    newOrderSound.play();
                } catch (e) {
                    console.error('Error playing sound:', e);
                }
            }
        });
        
        // Initial data load
        fetchActiveOrders();
        
        // Set up refresh button
        refreshBtn.addEventListener('click', function() {
            startRefreshAnimation();
            fetchActiveOrders();
        });
        
        // Function to fetch active orders
        function fetchActiveOrders() {
            startRefreshAnimation();
            
            fetch('/api/active-orders')
            .then(response => response.json())
            .then(data => {
                    if (data.success) {
                        displayActiveOrders(data.orders);
                        updateLastUpdatedTime();
                } else {
                        console.error('Error fetching orders:', data.message);
                }
            })
            .catch(error => {
                console.error('Error fetching orders:', error);
                })
                .finally(() => {
                    stopRefreshAnimation();
                });
        }
        
        // Function to handle real-time order updates
        function updateOrderInUI(data) {
            const { type, order } = data;
            
            if (type === 'new') {
                // Check if the order already exists in the UI
                const existingOrder = document.querySelector(`.order-card[data-order-id="${order.id}"]`);
                if (!existingOrder) {
                    // New order, fetch all active orders to refresh the view
                    fetchActiveOrders();
                }
            } else if (type === 'status_change') {
                // Find the order in the UI
                const orderElement = document.querySelector(`.order-card[data-order-id="${order.id}"]`);
                
                if (orderElement) {
                    // Update the status badge
                    const statusBadge = orderElement.querySelector('.status-badge');
                    if (statusBadge) {
                        statusBadge.className = `status-badge status-${order.status}`;
                        statusBadge.textContent = order.status.charAt(0).toUpperCase() + order.status.slice(1);
                    }
                    
                    // Update the action buttons
                    updateActionButtons(orderElement, order);
                    
                    // If status is 'completed' or 'cancelled', handle accordingly
                    if (order.status === 'completed' || order.status === 'cancelled') {
                        // Option 1: Remove the order from active orders after a delay
                        setTimeout(() => {
                            orderElement.style.opacity = '0';
                            setTimeout(() => {
                                orderElement.remove();
                                checkNoOrders();
                            }, 500);
                        }, 2000);
                        
                        // Option 2: Fetch all orders to refresh the view
                        // setTimeout(fetchActiveOrders, 2000);
                    }
                } else {
                    // If order doesn't exist in the UI, fetch all active orders
                    fetchActiveOrders();
                }
            } else if (type === 'completed') {
                // Remove the order from the UI
                const orderElement = document.querySelector(`.order-card[data-order-id="${order.id}"]`);
                if (orderElement) {
                    orderElement.style.opacity = '0';
                    setTimeout(() => {
                        orderElement.remove();
                        checkNoOrders();
                    }, 500);
                }
            }
        }
        
        // Check if there are no orders and display a message
        function checkNoOrders() {
            const orders = document.querySelectorAll('.order-card');
            if (orders.length === 0) {
                activeOrdersContainer.innerHTML = `
                    <div class="no-orders-message">
                        <i class="fas fa-coffee fa-2x mb-3"></i>
                        <h5>No active orders at the moment</h5>
                        <p class="mb-0">New orders will appear here automatically</p>
                    </div>
                `;
            }
        }
        
        // Update action buttons based on order status
        function updateActionButtons(orderElement, order) {
            const actionsContainer = orderElement.querySelector('.d-flex.justify-content-between.align-items-center div:last-child');
            if (!actionsContainer) return;
            
            let actionButtonHTML = '';
            
            if (order.status === 'pending') {
                actionButtonHTML = `
                    <div class="d-flex gap-2 mt-3">
                        <button class="btn btn-sm btn-primary" onclick="updateOrderStatus(${order.id}, 'preparing')">
                            <i class="fas fa-utensils me-1"></i>Start Preparing
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="cancelOrder(${order.id})">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>
                    </div>
                `;
            } else if (order.status === 'preparing') {
                actionButtonHTML = `
                    <div class="d-flex gap-2 mt-3">
                        <button class="btn btn-sm btn-success" onclick="updateOrderStatus(${order.id}, 'ready')">
                            <i class="fas fa-check me-1"></i>Mark Ready
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="cancelOrder(${order.id})">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>
                    </div>
                `;
            } else if (order.status === 'ready') {
                actionButtonHTML = `
                    <div class="d-flex gap-2 mt-3">
                        <button class="btn btn-sm btn-secondary" onclick="updateOrderStatus(${order.id}, 'completed')">
                            <i class="fas fa-check-double me-1"></i>Mark Completed
                        </button>
                    </div>
                `;
            }
            
            actionsContainer.innerHTML = actionButtonHTML;
            
            // Reattach event listeners
            attachButtonListeners();
        }
        
        // Display active orders
        function displayActiveOrders(orders) {
            // If no orders, show message
            if (!orders || orders.length === 0) {
                activeOrdersContainer.innerHTML = `
                    <div class="no-orders-message">
                        <i class="fas fa-coffee fa-2x mb-3"></i>
                        <h5>No active orders at the moment</h5>
                        <p class="mb-0">New orders will appear here automatically</p>
                    </div>
                `;
                return;
            }
            
            // Build HTML for orders in a grid
            let ordersHTML = '<div class="orders-grid">';
            
            orders.forEach(order => {
                // Build items HTML
                let itemsHTML = '';
                
                order.items.forEach(item => {
                    const itemTotal = item.quantity * item.unit_price;
                    
                    itemsHTML += `
                        <div class="order-item-card">
                            <div class="item-quantity">${item.quantity}x</div>
                            <div class="item-name">${item.name}</div>
                            <div class="item-price">$${itemTotal.toFixed(2)}</div>
                        </div>
                    `;
                });
                
                // Special instructions alert
                let specialInstructionsHTML = '';
                if (order.special_instructions) {
                    specialInstructionsHTML = `
                        <div class="alert alert-info mb-2 p-2">
                            <strong><i class="fas fa-info-circle me-1"></i>Special:</strong>
                            <small>${order.special_instructions}</small>
                        </div>
                    `;
                }
                
                // Payment method badge
                let paymentBadgeHTML = '';
                if (order.payment_method) {
                    const badgeClass = order.payment_status === 'paid' ? 'success' : 'warning';
                    const icon = order.payment_method === 'now' ? 'credit-card' : 'money-bill-wave';
                    const text = (order.payment_method === 'now' && order.payment_status === 'paid') 
                        ? 'Paid (Card)' : 'Pay at Table';
                    
                    paymentBadgeHTML = `
                        <div class="text-end mt-2">
                            <span class="badge bg-${badgeClass}">
                                <i class="fas fa-${icon} me-1"></i>
                                ${text}
                            </span>
                        </div>
                    `;
                }
                
                // Build action buttons based on status
                let actionButtons = '';
                
                if (order.status === 'pending') {
                    actionButtons = `
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-sm btn-primary" onclick="updateOrderStatus(${order.id}, 'preparing')">
                                <i class="fas fa-utensils me-1"></i>Start Preparing
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="cancelOrder(${order.id})">
                                <i class="fas fa-times me-1"></i>Cancel
                            </button>
                        </div>
                    `;
                } else if (order.status === 'preparing') {
                    actionButtons = `
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-sm btn-success" onclick="updateOrderStatus(${order.id}, 'ready')">
                                <i class="fas fa-check me-1"></i>Mark Ready
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="cancelOrder(${order.id})">
                                <i class="fas fa-times me-1"></i>Cancel
                            </button>
                        </div>
                    `;
                } else if (order.status === 'ready') {
                    actionButtons = `
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-sm btn-secondary" onclick="updateOrderStatus(${order.id}, 'completed')">
                                <i class="fas fa-check-double me-1"></i>Mark Completed
                            </button>
                        </div>
                    `;
                }
                
                // Format date for display
                const orderDate = new Date(order.created_at);
                const formattedTime = orderDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Phone number display
                const phoneDisplay = order.customer_phone ? 
                    `<i class="fas fa-phone ms-2 me-1"></i> ${order.customer_phone}` : '';
                
                // Build order card
                ordersHTML += `
                    <div class="order-card" data-order-id="${order.id}">
                        <div class="card-header order-header">
                <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Order #${order.id}</h5>
                                <span class="status-badge status-${order.status}">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</span>
                </div>
                            <div class="text-muted mt-1">
                                <i class="fas fa-chair me-1"></i> Table ${order.table_number} 
                                <i class="fas fa-clock ms-2 me-1"></i> ${formattedTime}
                                ${phoneDisplay}
                </div>
            </div>
            <div class="card-body">
                            <!-- Grid layout for items -->
                            <div class="item-grid mb-2">
                                ${itemsHTML}
                            </div>
                            
                            ${specialInstructionsHTML}
                            
                            <div class="order-total">
                                <div class="d-flex justify-content-between mb-1">
                                    <small>Subtotal:</small>
                                    <small>$${order.total_amount.toFixed(2)}</small>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <small>Tax (8%):</small>
                                    <small>$${order.tax_amount.toFixed(2)}</small>
                                </div>
                                <div class="d-flex justify-content-between fw-bold">
                                    <span>Total:</span>
                                    <span>$${order.final_amount.toFixed(2)}</span>
                                </div>
                                ${paymentBadgeHTML}
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary print-receipt-btn" 
                                            onclick="printReceipt(${order.id})">
                                        <i class="fas fa-print me-1"></i> Print
                    </button>
                                </div>
                                <div>
                                    ${actionButtons}
                                </div>
                            </div>
                </div>
            </div>
        `;
            });
            
            ordersHTML += '</div>';
            
            // Update the container
            activeOrdersContainer.innerHTML = ordersHTML;
            
            // Attach event listeners to the buttons
            attachButtonListeners();
        }
        
        // Start refresh animation
        function startRefreshAnimation() {
            refreshBtn.disabled = true;
            refreshIcon.classList.add('refresh-icon');
        }
        
        // Stop refresh animation
        function stopRefreshAnimation() {
            refreshBtn.disabled = false;
            refreshIcon.classList.remove('refresh-icon');
        }
        
        // Update the "last updated" timestamp
        function updateLastUpdatedTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            lastUpdated.textContent = `Last updated: ${timeString}`;
        }
        
        // Attach event listeners to status update buttons
        function attachButtonListeners() {
            const statusButtons = document.querySelectorAll('.quick-status-btn');
            
            statusButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const orderId = this.dataset.orderId;
                    const newStatus = this.dataset.status;
                    
                    updateOrderStatus(orderId, newStatus);
                });
            });
        }
        
        // Handle order status update
    function updateOrderStatus(orderId, newStatus) {
            // Show loading spinner
            const statusBadge = document.querySelector(`.status-badge[data-order-id="${orderId}"]`);
            const originalContent = statusBadge.innerHTML;
            statusBadge.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Updating...';
            
        fetch(`/api/orders/${orderId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
                body: JSON.stringify({
                    status: newStatus
                })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`Order status updated: ${orderId} -> ${newStatus}`);
                    // Socket.IO will update the UI
                } else {
                    // Restore original content on error
                    statusBadge.innerHTML = originalContent;
                    alert('Error updating order status: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error updating order status:', error);
                // Restore original content on error
                statusBadge.innerHTML = originalContent;
                alert('Error updating order status. Please try again.');
            });
        }
        
        // Cancel order function
        function cancelOrder(orderId) {
            if (!confirm('Are you sure you want to cancel this order? This cannot be undone.')) {
                return;
            }
            
            // Show loading spinner
            const statusBadge = document.querySelector(`.status-badge[data-order-id="${orderId}"]`);
            const originalContent = statusBadge.innerHTML;
            statusBadge.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Cancelling...';
            
            fetch(`/api/orders/${orderId}/cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`Order cancelled: ${orderId}`);
                    // Socket.IO will update the UI
                    
                    // If Socket.IO doesn't update in time, update manually
                    setTimeout(() => {
                        // If the order is still in the DOM, update it
                        if (statusBadge && document.contains(statusBadge)) {
                            statusBadge.innerHTML = 'Cancelled';
                            statusBadge.className = 'status-badge bg-danger text-white';
                        }
                        
                        // Refresh active orders
                        fetchActiveOrders();
                    }, 1000);
                } else {
                    // Restore original content on error
                    statusBadge.innerHTML = originalContent;
                    alert('Error cancelling order: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error cancelling order:', error);
                // Restore original content on error
                statusBadge.innerHTML = originalContent;
                alert('Error cancelling order. Please try again.');
            });
        }
    });

    // Function to print receipt
    function printReceipt(orderId) {
        // Open receipt in new window
        const receiptUrl = `/order/${orderId}/receipt?print=true`;
        const printWindow = window.open(receiptUrl, '_blank', 'width=600,height=600');
    }
</script>
{% endblock %}